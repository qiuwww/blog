## 3-3.å¼€å‘æ’ä»¶ plugin æ¥ä¿®æ”¹ webpack çš„è¾“å‡º

plugin æœ‰å¾ˆå¤šçš„ç”Ÿå‘½å‘¨æœŸï¼Œä½†æ˜¯ç›®æ ‡ä»£ç åœ°å€éƒ½åœ¨ compilation.assetsï¼Œæ‰€ä»¥ä¿®æ”¹ä»£ç éƒ½æ˜¯åŸºäºæ­¤ã€‚

### å¼€å‘ä¸€ä¸ª webpack æ’ä»¶çš„[åŸºæœ¬æ­¥éª¤](https://webpack.docschina.org/contribute/writing-a-plugin/#creating-a-plugin)

webpack æ’ä»¶ç”±ä»¥ä¸‹ç»„æˆï¼š

1. ä¸€ä¸ª JavaScript å‘½åå‡½æ•°æˆ– JavaScript ç±»ã€‚
2. åœ¨æ’ä»¶å‡½æ•°çš„ prototype ä¸Šå®šä¹‰ä¸€ä¸ª apply æ–¹æ³•ã€‚
3. æŒ‡å®šä¸€ä¸ªç»‘å®šåˆ° webpack è‡ªèº«çš„äº‹ä»¶é’©å­ã€‚
4. å¤„ç† webpack å†…éƒ¨å®ä¾‹çš„ç‰¹å®šæ•°æ®ã€‚
5. åŠŸèƒ½å®Œæˆåè°ƒç”¨ webpack æä¾›çš„å›è°ƒã€‚

```js
// ä¸€ä¸ª JavaScript ç±»
class MyExampleWebpackPlugin {
  // åœ¨æ’ä»¶å‡½æ•°çš„ prototype ä¸Šå®šä¹‰ä¸€ä¸ª `apply` æ–¹æ³•ï¼Œä»¥ compiler ä¸ºå‚æ•°ã€‚
  apply(compiler) {
    // æŒ‡å®šä¸€ä¸ªæŒ‚è½½åˆ° webpack è‡ªèº«çš„äº‹ä»¶é’©å­ã€‚
    compiler.hooks.emit.tapAsync('MyExampleWebpackPlugin', (compilation, callback) => {
      console.log('è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹æ’ä»¶ï¼');
      console.log('è¿™é‡Œè¡¨ç¤ºäº†èµ„æºçš„å•æ¬¡æ„å»ºçš„ `compilation` å¯¹è±¡ï¼š', compilation);

      // ç”¨ webpack æä¾›çš„æ’ä»¶ API å¤„ç†æ„å»ºè¿‡ç¨‹
      compilation.addModule(/* ... */);

      callback();
    });
  }
}
```

### æœ¬ç¤ºä¾‹ä¸­çš„ plugin

**åŸå§‹ä»£ç **ï¼š

```js
// webpack5-modify-assets/src/modify-by-plugin.js
console.log('modify-by-plugin!');
function square(n) {
  console.log('n', n);
  return n * n;
}

square(2);

debugger;

var hahaha = 9527;

console.log('heiheihei');
```

```js
// webpack5-modify-assets/scripts/babelModify.js
const parser = require('@babel/parser');
const fs = require('fs');
const traverse = require('@babel/traverse').default;
const generate = require('@babel/generator').default;
const types = require('@babel/types');

// è¿™é‡Œä»æ—§ä¿®æ”¹çš„æ˜¯assetsï¼Œä½†æ˜¯å¯¹å†…éƒ¨è¿›è¡Œäº†äºŒæ¬¡astè½¬æ¢ï¼Œæ‰¾åˆ°ç›®æ ‡ä»£ç ï¼Œè¿›è¡Œäº†ä¿®æ”¹
module.exports = function (code) {
  // æ‹¿åˆ°æ–‡ä»¶çš„codeï¼Œè½¬ä¸ºastç»“æ„
  const ast = parser.parse(code);
  fs.writeFileSync(__dirname + '/middle/input1.json', JSON.stringify(ast));
  fs.writeFileSync(__dirname + '/middle/input1.js', code);

  traverse(ast, {
    enter(path) {
      // åŒ¹é…åˆ°nameæ˜¯nçš„æ”¹ä¸ºx
      // è¿™é‡ŒåŒ¹é…åˆ°ç›®æ ‡source
      if (
        path.node.type === 'StringLiteral' &&
        path.node.value.includes(
          '# sourceURL=webpack://webpack5-modify-assets/./src/modify-by-plugin.js?',
        )
      ) {
        const subAst = parser.parse(path.node.value);
        fs.writeFileSync(__dirname + '/middle/input2.json', JSON.stringify(subAst));
        fs.writeFileSync(__dirname + '/middle/input2.js', path.node.value);

        traverse(subAst, {
          enter(path) {
            // æ“ä½œ1ï¼Œä¿®æ”¹ç»“æœ
            if (path.node.type === 'NumericLiteral' && path.node.value === 9527) {
              // æ›¿æ¢æ•°å€¼ç±»å‹9527ä¸º9528
              path.node.value = 9528;
            }
            // æ“ä½œ2ï¼Œä¿®æ”¹ç›®æ ‡å­—ç¬¦ä¸²
            if (path.node.type === 'StringLiteral' && path.node.value === 'heiheihei') {
              path.node.value = 'heiheihei heiheihei';
            }
          },

          // ä¿®æ”¹3
          // ç›´æ¥åˆ é™¤äº†debugger
          DebuggerStatement(path) {
            // å½“é‡åˆ°debuggerè¯­å¥æ—¶ï¼Œå°†å…¶ä»ASTä¸­åˆ é™¤
            path.remove();
          },
        });
        // é‡æ–°å¡«å…¥astä¸­çš„ç›®æ ‡èŠ‚ç‚¹
        path.node.value = generate(subAst, {}).code;
      }
    },
  });
  // ast -> code
  return generate(ast, {}).code;
};
```

**ç» plugin å¤„ç†**ï¼š

```js
// webpack5-modify-assets/scripts/plugin-modify.js

const pluginName = 'PluginModify';
const babelModify = require('./babelModify.js');

/**
 * è¿™é‡Œä¼¼ä¹å¯ä»¥è¿™æ ·ç†è§£ï¼š
 * 1. assetsä»£è¡¨çš„æ˜¯åŸå§‹çš„ä»£ç ï¼Œä¿®æ”¹äº†ä¼šå½±å“åˆ°ç›®æ ‡ç»“æœï¼›=> ä¿®æ”¹æ¨¡å—ä»£ç :åœ¨ compilation é˜¶æ®µï¼Œä½ å¯ä»¥ç›‘å¬ optimize-chunk-assets äº‹ä»¶ï¼Œå®ƒä¼šæä¾›è¾“å‡ºçš„ chunk å¯¹è±¡ã€‚ä½ å¯ä»¥éå†è¿™äº› chunkï¼Œè·å–æ¨¡å—çš„ä»£ç ï¼Œç„¶åä¿®æ”¹ä»£ç ï¼Œæœ€åé€šè¿‡ compilation.assets å¯¹è±¡å°†ä¿®æ”¹åçš„ä»£ç é‡æ–°å†™å…¥åˆ°è¾“å‡ºæ–‡ä»¶ä¸­ã€‚
 *   1.1 éƒ½æ˜¯èµ°åˆ°äº†compilation.assets[fileName]ï¼›
 * 2. chunkså’Œmodulesä¿®æ”¹äº†ä¹Ÿåªæ˜¯ä¿®æ”¹äº†ï¼Œæ²¡ä»€ä¹ˆç”¨ï¼›
 * 3. compiler.hooks.normalModuleFactoryåº”è¯¥ä¹Ÿæ˜¯åŒæ ·çš„é—®é¢˜
 */

class PluginModify {
  constructor(options = {}) {
    this.options = options;
  }

  apply(compiler) {
    // æ–¹å¼ä¸€
    compiler.hooks.emit.tapAsync(pluginName, (compilation, cb) => {
      //å¯éå†å‡ºæ‰€æœ‰çš„èµ„æºå
      for (var filename in compilation.assets) {
        // console.log('MyModifyOutput name==', filename);
      }
      compilation.chunks.forEach(function (chunk) {
        chunk.files.forEach(function (filename) {
          // compilation.assets å­˜æ”¾å½“å‰æ‰€æœ‰å³å°†è¾“å‡ºçš„èµ„æº
          let source = compilation.assets[filename].source();
          // è¿™é‡Œå¯ä»¥æ ¹æ®æ‰©å±•åè¿›è¡Œä¸åŒçš„æ“ä½œ

          if (filename.includes('.js') && filename.includes('modifyByPlugin')) {
            // æ–¹å¼ä¸€
            source =
              "console.log('å“ˆå“ˆå“ˆå“ˆå“ˆğŸ˜„');\n" +
              source +
              "\n;console.log('add by plugin-modify-1!');";
            // æ–¹å¼äºŒ
            // é€šè¿‡babelåˆ†æåï¼Œç»“æ„åŒ–æ·»åŠ 
            source = babelModify(source);
            source = `${source}`;
          }

          // è¿™é‡Œä¿®æ”¹çš„æ˜¯assets
          compilation.assets[filename] = {
            source: function () {
              return source;
            },
            size: function () {
              return source.length;
            },
          };
        });
      });
      cb();
    });

    // !è¿™ä¸ªä¼šåœ¨emitå‰é¢æ·»åŠ 
    compiler.hooks.compilation.tap(pluginName, (compilation) => {
      compilation.hooks.optimizeChunkAssets.tapAsync(pluginName, (chunks, callback) => {
        chunks.forEach((chunk) => {
          // éå†å—çš„æ‰€æœ‰æ–‡ä»¶
          chunk.files.forEach((file) => {
            if (file.endsWith('.js')) {
              // è·å–æ–‡ä»¶å†…å®¹
              // webpackå¤„ç†è¿‡çš„ä»£ç 
              let source = compilation.assets[file].source();
              // åœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ è‡ªå®šä¹‰æ³¨é‡Š
              source = `/* Â¥Â¥Â¥Â¥Â¥Â¥Â¥Â¥Â¥Â¥Â¥Â¥Â¥Â¥Â¥Â¥Â¥Â¥Â¥Â¥Â¥ */\n${source}`;
              // å°†ä¿®æ”¹åçš„å†…å®¹å†™å›æ–‡ä»¶
              compilation.assets[file] = {
                source: () => source,
                size: () => source.length,
              };
            }
          });
        });

        // æ‰§è¡Œå›è°ƒå‡½æ•°
        callback();
      });
    });

    compiler.hooks.done.tap(pluginName, (compilation) => {
      console.log('webpack æ„å»ºå®Œæ¯•ï¼ï¼ï¼');
    });
  }
}

module.exports = PluginModify;
```

![plugin-ast](./imgs/plugin-ast.png)

![plugin-modify-result](./imgs/plugin-modify-result.png)

**ç›®æ ‡ç»“æœ**ï¼Œè¿™é‡Œé¦–å…ˆé€šè¿‡ code ç›´æ¥æ‹¼æ¥çš„æ–¹å¼ï¼Œæ·»åŠ äº†ä¸€æ®µæ‰“å°ä¿¡æ¯ã€‚ç„¶åä¿®æ”¹äº†å˜é‡çš„ valueï¼Œåˆ é™¤äº† debugger å­—æ®µã€‚
